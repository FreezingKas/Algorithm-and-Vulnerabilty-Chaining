from utils import args_formatter, roundup
from variables import parameters_value


class Vulnerability:
    def __init__(self, tab: list):
        """
        Parameters are private because user doesn't have to change parameters
        TODO: we can change this but i have to build new method to check the validity of new parameters
        :param tab:
        """
        args_formatter(tab)
        self.__AV = tab[0]
        self.__AC = tab[1]
        self.__PR = tab[2]
        self.__UI = tab[3]
        self.__S = tab[4]
        self.__CI = tab[5]
        self.__II = tab[6]
        self.__AI = tab[7]

        self.__exploitability = 0.
        self.__impact = 0.
        self.__basescore = 0.

    def can_chain_with(self, other_vuln) -> bool:
        """
        Check if we vulnerability can be neighbour in a chain
        :param other_vuln:
        :return:
        """
        check = True
        if self.__AV == "network":
            if not other_vuln.__AV == "local" or not other_vuln.__AV == "network":
                check = False

        if self.__AV == "adjacent_network":
            if not other_vuln.__AV == "local" or not other_vuln.__AV == "adjacent_network":
                check = False

        if self.__PR == "none":
            check = not other_vuln.__PR == "none" or not other_vuln.__PR == "low"

        if self.__PR == "low":
            check = not other_vuln.__PR == "none" or not other_vuln.__PR == "low" or not other_vuln.__PR == "high"

        if self.__PR == "high":
            check = not other_vuln.__PR == "low" or not other_vuln.__PR == "high"

        return check

    def __calculate_exploitability(self):
        """
        Calculate exploitability
        """
        # before calculating exploitability we have to check the scope
        # for the value of PrivilegeRequired
        if self.__S == "changed":
            parameters_value["PrivilegesRequired"]["low"] = 0.68
            parameters_value["PrivilegesRequired"]["high"] = 0.5
        elif self.__S == "unchanged":
            parameters_value["PrivilegesRequired"]["low"] = 0.62
            parameters_value["PrivilegesRequired"]["high"] = 0.27

        self.exploitability = 8.22 * parameters_value["AttackVector"][self.__AV] \
                                   * parameters_value["AttackComplexity"][self.__AC] \
                                   * parameters_value["PrivilegesRequired"][self.__PR] \
                                   * parameters_value["UserInteraction"][self.__UI]

    def __calculate_impact(self):
        """
        Calculate Impact
        """
        # First we have to calculate ISS
        ISS = 1 - ((1 - parameters_value["ConfidentialityImpact"][self.__CI])
                   * (1 - parameters_value["IntegrityImpact"][self.__II])
                   * (1 - parameters_value["AvailabilityImpact"][self.__AI]))

        # now we can calculate impact
        if self.__S == "unchanged":
            self.impact = 6.42 * ISS
        elif self.__S == "changed":
            self.impact = 7.52 * (ISS - 0.029) - 3.25 * ((ISS - 0.02) ** 15)

    def __calculate_basescore(self) -> float:
        """
        Calculate CVSS
        """

        # Now we can calculate the BaseScore
        if self.impact <= 0:
            return 0
        else:
            if self.__S == "unchanged":
                self.basescore = roundup(min(self.impact + self.exploitability, 10), 1)
            elif self.__S == "changed":
                self.basescore = roundup(min(1.08 * (self.impact + self.exploitability), 10), 1)

    # Getter
    def get_impact(self):
        self.__calculate_impact()
        return self.impact

    def get_exploitability(self):
        self.__calculate_exploitability()
        return self.exploitability

    def get_basescore(self):
        self.__calculate_impact()
        self.__calculate_exploitability()
        self.__calculate_basescore()
        return self.basescore

    def get_attack_vector(self):
        return self.__AV

    def get_attack_complexity(self):
        return self.__AC

    def get_privileges_required(self):
        return self.__PR

    def get_user_interaction(self):
        return self.__UI

    def get_scope(self):
        return self.__S

    def get_confidentiality_impact(self):
        return self.__CI

    def get_integrity_impact(self):
        return self.__II

    def get_availability_impact(self):
        return self.__AI

    # str method (i don't want to print each members one by one)
    def __str__(self):
        return (self.__AV + " " + self.__AC + " " + self.__PR + " " + self.__UI + " "
                + self.__S + " " + self.__CI + " " + self.__CI + " " + self.__II + " " + self.__AI)
